:{$PORT} {
    log {
        format json
    }

    @forbidden {
        header X-API-Key !{$API_KEY}
    }

    rewrite @forbidden /forbidden
    status 403 /forbidden

    reverse_proxy {
        dynamic a {
            name {$UPSTREAM_DOMAIN}
            port {$UPSTREAM_PORT}
            refresh 1s
            dial_timeout 30s
            versions ipv4 ipv6
        }
    }

    handle /forbidden {
        respond 403
    }
}
